<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlo de Pressão Arterial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 300px; max-height: 40vh; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #14b8a6; border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { transition: opacity 0.25s ease; }
        #app-content.hidden { display: none; }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <!-- ECRÃ DE LOGIN -->
    <div id="login-screen" class="fixed inset-0 bg-teal-800 flex items-center justify-center p-4 z-50">
        <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-2xl text-center">
            <h2 class="text-2xl font-bold text-teal-800 mb-2">Acesso Seguro</h2>
            <p class="text-stone-600 mb-6">Digite a senha para aceder aos registos.</p>
            <form id="login-form">
                <input type="password" id="password-input" class="w-full px-4 py-3 border border-stone-300 rounded-lg shadow-sm text-center text-lg tracking-widest focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="••••••">
                <p id="login-error" class="text-red-500 text-sm mt-2 h-5"></p>
                <button type="submit" class="w-full mt-4 bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-transform transform hover:scale-105 shadow-md">
                    Entrar
                </button>
            </form>
        </div>
    </div>
    
    <!-- CONTEÚDO PRINCIPAL DA APLICAÇÃO (INICIALMENTE OCULTO) -->
    <div id="app-content" class="hidden">
        <div id="app-loader" class="fixed inset-0 bg-white bg-opacity-80 flex flex-col items-center justify-center z-40 backdrop-blur-sm">
            <div class="loader"></div>
            <p class="mt-4 text-teal-700 font-semibold">A carregar dados...</p>
        </div>

        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-teal-800">Controlo de Pressão Arterial</h1>
                <div class="flex justify-center items-center gap-4 mt-2">
                    <p class="text-lg text-stone-600" id="patient-name-header"></p>
                    <button id="open-modal-btn" class="bg-white border border-teal-600 text-teal-600 font-bold py-1 px-3 rounded-lg hover:bg-teal-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition text-sm">Editar Dados do Paciente</button>
                </div>
            </header>

            <main class="space-y-8">
                <!-- Secção Adicionar Medição -->
                <section id="add-reading" class="bg-white p-6 rounded-2xl shadow-lg border border-stone-200">
                    <h2 class="text-2xl font-semibold mb-4 text-teal-700">Adicionar Nova Medição</h2>
                    <form id="pressure-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="date" class="block text-sm font-medium text-stone-600 mb-1">Data</label>
                            <input type="date" id="date" name="date" required class="w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                        </div>
                        <div>
                            <label for="time" class="block text-sm font-medium text-stone-600 mb-1">Hora</label>
                            <input type="time" id="time" name="time" required class="w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                               <label for="systolic" class="block text-sm font-medium text-stone-600 mb-1">Sistólica (SYS)</label>
                               <input type="number" id="systolic" name="systolic" placeholder="ex: 120" required class="w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                            </div>
                            <div>
                               <label for="diastolic" class="block text-sm font-medium text-stone-600 mb-1">Diastólica (DIA)</label>
                               <input type="number" id="diastolic" name="diastolic" placeholder="ex: 80" required class="w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                            </div>
                        </div>
                        <button id="save-reading-btn" type="submit" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-transform transform hover:scale-105 shadow-md">
                            Guardar Medição
                        </button>
                    </form>
                     <p id="form-error" class="text-red-500 text-sm mt-2 hidden"></p>
                </section>
                
                <!-- Secção Gráfico -->
                <section id="visualization" class="bg-white p-6 rounded-2xl shadow-lg border border-stone-200">
                    <h2 class="text-2xl font-semibold mb-4 text-center text-teal-700">Tendência da Pressão Arterial</h2>
                    <div class="chart-container">
                        <canvas id="pressureChart"></canvas>
                    </div>
                </section>
                
                <!-- Secção Histórico -->
                <section id="history" class="bg-white p-6 rounded-2xl shadow-lg border border-stone-200">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h2 class="text-2xl font-semibold text-teal-700">Histórico de Medições</h2>
                           <button id="download-pdf-btn" class="mt-4 sm:mt-0 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition shadow-md">
                                 Transferir Histórico (PDF)
                           </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="border-b-2 border-stone-200">
                                    <th class="p-3 text-sm font-semibold tracking-wider">Data</th>
                                    <th class="p-3 text-sm font-semibold tracking-wider">Hora</th>
                                    <th class="p-3 text-sm font-semibold tracking-wider">Pressão (SIS/DIA)</th>
                                    <th class="p-3 text-sm font-semibold tracking-wider">Classificação</th>
                                    <th class="p-3 text-sm font-semibold tracking-wider text-center">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                            </tbody>
                        </table>
                         <p id="no-data-message" class="text-center text-stone-500 py-8 hidden">Nenhuma medição registada ainda.</p>
                    </div>
                </section>
                
                <!-- Secção IA -->
                <section id="gemini-features" class="bg-white p-6 rounded-2xl shadow-lg border border-stone-200">
                    <h2 class="text-2xl font-semibold mb-4 text-teal-700">Análise Inteligente</h2>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                           <button id="analyze-btn" class="flex-1 bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-transform transform hover:scale-105 shadow-md">
                                 ✨ Gerar Análise dos Dados
                           </button>
                           <button id="tip-btn" class="flex-1 bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-transform transform hover:scale-105 shadow-md">
                                 ✨ Gerar Dica de Saúde
                           </button>
                    </div>
                    <div id="gemini-output" class="mt-4 p-4 bg-stone-100 rounded-lg min-h-[100px] border border-stone-200 text-stone-700 whitespace-pre-wrap">
                        <div id="loading-spinner" class="hidden mx-auto loader"></div>
                        <p id="analysis-result"></p>
                    </div>
                </section>
            </main>
            
            <footer class="text-center mt-8 py-4">
                <p id="user-info" class="text-xs text-stone-400 mt-2"></p>
            </footer>
        </div>
        
        <!-- Modal de Dados do Paciente -->
        <div id="patient-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-20">
            <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 sm:p-8 transform transition-transform scale-95 max-h-[90vh] overflow-y-auto">
                <h2 class="text-2xl font-bold mb-6 text-teal-800">Dados do Paciente</h2>
                
                <form id="patient-form" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="patient-name" class="block text-sm font-medium text-stone-600">Nome Completo</label>
                            <input type="text" id="patient-name" class="mt-1 w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                         <div>
                            <label for="patient-dob" class="block text-sm font-medium text-stone-600">Data de Nascimento</label>
                            <input type="date" id="patient-dob" class="mt-1 w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label for="patient-weight" class="block text-sm font-medium text-stone-600">Peso (kg)</label>
                            <input type="number" step="0.1" id="patient-weight" class="mt-1 w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                        <div>
                            <label for="patient-height" class="block text-sm font-medium text-stone-600">Altura (m)</label>
                            <input type="number" step="0.01" id="patient-height" class="mt-1 w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                        </div>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-stone-600 mb-2">Outras Condições de Saúde (opcional)</label>
                        <textarea id="patient-conditions" rows="3" placeholder="Ex: Diabetes tipo 2, Colesterol alto" class="w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500"></textarea>
                    </div>
                </form>
                
                <hr class="my-6 border-stone-200">
                
                <h3 class="text-xl font-semibold mb-4 text-teal-700">Medicações em Uso</h3>
                <div id="modal-medications-list" class="space-y-2 mb-4 max-h-40 overflow-y-auto"></div>
                <form id="medication-form" class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                    <div class="sm:col-span-1">
                        <label for="medication-name" class="block text-sm font-medium text-stone-600 mb-1">Nome da Medicação</label>
                        <input type="text" id="medication-name" placeholder="Ex: Losartana" class="w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div class="sm:col-span-1">
                        <label for="medication-frequency" class="block text-sm font-medium text-stone-600 mb-1">Frequência</label>
                        <input type="text" id="medication-frequency" placeholder="Ex: 1 vez ao dia" class="w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div class="sm:col-span-1">
                           <button type="submit" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-transform transform hover:scale-105 shadow-md">Adicionar</button>
                    </div>
                </form>

                <div class="flex justify-end gap-4 mt-8">
                    <button id="close-modal-btn" class="bg-stone-200 text-stone-800 font-bold py-2 px-6 rounded-lg hover:bg-stone-300 transition">Fechar</button>
                    <button id="save-profile-btn" class="bg-teal-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-700 transition shadow-md">Guardar Alterações</button>
                </div>
            </div>
        </div>

        <!-- Modal de Confirmação para Exclusão -->
        <div id="confirmation-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0 z-50">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6 sm:p-8 text-center transform transition-transform scale-95">
                <h3 id="confirmation-title" class="text-xl font-bold mb-4 text-stone-800">Confirmar Exclusão</h3>
                <p id="confirmation-message" class="text-stone-600 mb-6">Tem a certeza que deseja excluir esta medição? Esta ação não pode ser desfeita.</p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-delete-btn" class="bg-stone-200 text-stone-800 font-bold py-2 px-6 rounded-lg hover:bg-stone-300 transition">Cancelar</button>
                    <button id="confirm-delete-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition shadow-md">Excluir</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        document.addEventListener('DOMContentLoaded', () => {

            // --- PASSO 1: CONFIGURAÇÃO DO FIREBASE ---
            const firebaseConfig = {
              apiKey: "AIzaSyBLwU5-wAPNI2m3PkrFFu4qDFksYa1DRF4",
              authDomain: "pressao-arterial-jvitor.firebaseapp.com",
              projectId: "pressao-arterial-jvitor",
              storageBucket: "pressao-arterial-jvitor.appspot.com",
              messagingSenderId: "262625952329",
              appId: "1:262625952329:web:4eb36c92eb8d8c4d7b3598"
            };

            // --- PASSO 2: DEFINA O EMAIL E A SENHA ÚNICOS PARA O PROJETO ---
            // O email foi alterado uma última vez para garantir uma criação de conta 100% limpa.
            const APP_EMAIL = "app.master.user@pressaoarterial.com";
            const APP_PASSWORD = "Apto30211@";

            // --- Seletores de UI ---
            const ui = {
                loginScreen: document.getElementById('login-screen'),
                loginForm: document.getElementById('login-form'),
                passwordInput: document.getElementById('password-input'),
                loginError: document.getElementById('login-error'),
                appContent: document.getElementById('app-content'),
                appLoader: document.getElementById('app-loader'),
                pressureForm: document.getElementById('pressure-form'),
                dateInput: document.getElementById('date'),
                timeInput: document.getElementById('time'),
                systolicInput: document.getElementById('systolic'),
                diastolicInput: document.getElementById('diastolic'),
                tableBody: document.getElementById('history-table-body'),
                noDataMessage: document.getElementById('no-data-message'),
                formError: document.getElementById('form-error'),
                chartCanvas: document.getElementById('pressureChart'),
                analyzeBtn: document.getElementById('analyze-btn'),
                tipBtn: document.getElementById('tip-btn'),
                loadingSpinner: document.getElementById('loading-spinner'),
                analysisResult: document.getElementById('analysis-result'),
                downloadPdfBtn: document.getElementById('download-pdf-btn'),
                patientNameHeader: document.getElementById('patient-name-header'),
                patientModal: document.getElementById('patient-modal'),
                openModalBtn: document.getElementById('open-modal-btn'),
                closeModalBtn: document.getElementById('close-modal-btn'),
                saveProfileBtn: document.getElementById('save-profile-btn'),
                patientNameInput: document.getElementById('patient-name'),
                patientDobInput: document.getElementById('patient-dob'),
                patientWeightInput: document.getElementById('patient-weight'),
                patientHeightInput: document.getElementById('patient-height'),
                patientConditionsInput: document.getElementById('patient-conditions'),
                modalMedicationsListDiv: document.getElementById('modal-medications-list'),
                medicationForm: document.getElementById('medication-form'),
                medicationNameInput: document.getElementById('medication-name'),
                medicationFrequencyInput: document.getElementById('medication-frequency'),
                saveReadingBtn: document.getElementById('save-reading-btn'),
                userInfo: document.getElementById('user-info'),
                confirmationModal: document.getElementById('confirmation-modal'),
                confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
                cancelDeleteBtn: document.getElementById('cancel-delete-btn'),
            };

            let pressureChart;
            let patientProfile = {}; 
            let readings = [];
            let db, auth, userId;
            let readingToDeleteId = null; 
            
            const GEMINI_API_KEY = ""; 
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
            
            // --- LÓGICA DE LOGIN E AUTENTICAÇÃO ---
            const initializeFirebase = () => {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    ui.loginForm.addEventListener('submit', handleLogin);

                } catch (error) {
                    console.error("Erro fatal ao inicializar Firebase:", error);
                    ui.loginError.textContent = "Erro de configuração. Verifique a consola.";
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                const enteredPassword = ui.passwordInput.value;
                ui.loginError.textContent = '';

                // 1. Valida a senha no lado do cliente primeiro. Esta é a verificação principal.
                if (enteredPassword !== APP_PASSWORD) {
                    ui.loginError.textContent = 'Senha incorreta.';
                    return;
                }

                // 2. Se a senha estiver correta, tenta fazer login ou criar a conta.
                try {
                    // Tenta fazer login, pois será a ação mais comum após o primeiro acesso.
                    const userCredential = await signInWithEmailAndPassword(auth, APP_EMAIL, APP_PASSWORD);
                    userId = userCredential.user.uid;
                    initializeAppLogic();
                } catch (error) {
                    // Se o utilizador não existir, cria-o na primeira vez.
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                        try {
                            const newUserCredential = await createUserWithEmailAndPassword(auth, APP_EMAIL, APP_PASSWORD);
                            userId = newUserCredential.user.uid;
                            initializeAppLogic();
                        } catch (creationError) {
                            ui.loginError.textContent = 'Erro ao configurar a conta. Tente novamente.';
                            console.error("Erro de criação:", creationError);
                        }
                    } else {
                        // Para qualquer outro erro inesperado
                        ui.loginError.textContent = 'Ocorreu um erro. Verifique a consola.';
                        console.error("Erro de login inesperado:", error);
                    }
                }
            };
            
            const initializeAppLogic = () => {
                ui.loginScreen.style.display = 'none';
                ui.appContent.classList.remove('hidden');
                setupListeners();
                setDefaultDateTime();
            };

            // --- LÓGICA PRINCIPAL DA APLICAÇÃO ---

            const setupListeners = () => {
                if (!userId) return;
                
                const profileDocRef = doc(db, "userData", userId, "profile", "data");
                onSnapshot(profileDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        patientProfile = docSnap.data();
                    } else {
                        // Cria um perfil padrão se não existir
                        const defaultProfile = { name: "Maria José Martins", dob: "1967-01-14", weightKg: 68, heightM: 1.70, conditions: "Hipertensão", medications: [{ id: Date.now(), name: 'Losartana Potássica', frequency: '1 vez ao dia' }] };
                        setDoc(profileDocRef, defaultProfile);
                        patientProfile = defaultProfile;
                    }
                    renderAll();
                    ui.appLoader.style.display = 'none';
                });

                const readingsColRef = collection(db, "userData", userId, "readings");
                const q = query(readingsColRef, orderBy("datetime", "desc"));
                onSnapshot(q, (querySnapshot) => {
                    readings = [];
                    querySnapshot.forEach((doc) => {
                        readings.push({ id: doc.id, ...doc.data() });
                    });
                    renderAll();
                }, (error) => {
                    console.error("Erro ao procurar medições: ", error);
                    if (error.code === 'failed-precondition') {
                         alert("É necessário criar um índice no Firebase para ordenar os dados. Por favor, verifique a consola de registos para o link de criação.");
                    }
                });
            };

            const handleSaveProfile = async () => {
                const updatedProfile = {
                    name: ui.patientNameInput.value.trim(),
                    dob: ui.patientDobInput.value,
                    weightKg: parseFloat(ui.patientWeightInput.value) || 0,
                    heightM: parseFloat(ui.patientHeightInput.value) || 0,
                    conditions: ui.patientConditionsInput.value.trim(),
                    medications: patientProfile.medications || []
                };
                const profileDocRef = doc(db, "userData", userId, "profile", "data");
                await setDoc(profileDocRef, updatedProfile, { merge: true });
                toggleModal(false);
            };

            ui.pressureForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                ui.formError.classList.add('hidden');

                const sys = parseInt(ui.systolicInput.value);
                const dia = parseInt(ui.diastolicInput.value);

                if (isNaN(sys) || isNaN(dia) || sys <= 0 || dia <= 0 || sys < dia) {
                    ui.formError.textContent = 'Valores de pressão inválidos.';
                    ui.formError.classList.remove('hidden');
                    return;
                }

                const newReading = {
                    datetime: new Date(`${ui.dateInput.value}T${ui.timeInput.value}`),
                    sys: sys,
                    dia: dia
                };

                ui.saveReadingBtn.textContent = 'A guardar...';
                ui.saveReadingBtn.disabled = true;

                try {
                    const readingsColRef = collection(db, "userData", userId, "readings");
                    await addDoc(readingsColRef, newReading);
                    
                    ui.saveReadingBtn.innerHTML = 'Guardado!';
                    ui.saveReadingBtn.classList.replace('bg-teal-600', 'bg-green-600');
                    ui.pressureForm.reset();
                    setDefaultDateTime();

                    setTimeout(() => {
                        ui.saveReadingBtn.innerHTML = 'Guardar Medição';
                        ui.saveReadingBtn.classList.replace('bg-green-600', 'bg-teal-600');
                        ui.saveReadingBtn.disabled = false;
                    }, 2000);
                } catch (error) {
                    console.error("Erro ao guardar medição: ", error);
                    ui.formError.textContent = 'Erro ao guardar. Tente novamente.';
                    ui.formError.classList.remove('hidden');
                    ui.saveReadingBtn.disabled = false;
                    ui.saveReadingBtn.textContent = 'Guardar Medição';
                }
            });
            
            const getClassification = (sys, dia) => {
                if (sys < 120 && dia < 80) return { text: 'Ótima', color: 'bg-green-500' };
                if (sys < 130 && dia < 85) return { text: 'Normal', color: 'bg-blue-500' };
                if (sys < 140 || dia < 90) return { text: 'Limítrofe', color: 'bg-yellow-500' };
                if (sys < 160 || dia < 100) return { text: 'Hipertensão Leve', color: 'bg-orange-500' };
                if (sys < 180 || dia < 110) return { text: 'Hipertensão Moderada', color: 'bg-red-500' };
                if (sys >= 180 || dia >= 110) return { text: 'Hipertensão Grave', color: 'bg-red-700' };
                return { text: 'Não classificado', color: 'bg-gray-400' };
            };

            const renderTable = () => {
                ui.tableBody.innerHTML = '';
                if (readings.length === 0) {
                    ui.noDataMessage.classList.remove('hidden'); return;
                }
                ui.noDataMessage.classList.add('hidden');
                
                readings.forEach(reading => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-stone-200 hover:bg-stone-50';
                    const date = new Date(reading.datetime.seconds * 1000);
                    const classification = getClassification(reading.sys, reading.dia);
                    
                    row.innerHTML = `
                        <td class="p-3">${date.toLocaleDateString('pt-BR')}</td>
                        <td class="p-3">${date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</td>
                        <td class="p-3 font-medium">${reading.sys} / ${reading.dia}</td>
                        <td class="p-3"><span class="px-2 py-1 text-white text-xs font-bold rounded-full ${classification.color}">${classification.text}</span></td>
                        <td class="p-3 text-center">
                            <button data-id="${reading.id}" class="delete-btn text-red-500 hover:text-red-700 font-semibold text-sm">Excluir</button>
                        </td>
                    `;
                    ui.tableBody.appendChild(row);
                });
            };

            ui.tableBody.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    readingToDeleteId = deleteBtn.getAttribute('data-id');
                    toggleConfirmationModal(true);
                }
            });

             const toggleConfirmationModal = (show) => {
                const modalContent = ui.confirmationModal.querySelector('div');
                if (show) {
                    ui.confirmationModal.classList.remove('hidden');
                    setTimeout(() => {
                        ui.confirmationModal.classList.remove('opacity-0');
                        modalContent.classList.remove('scale-95');
                    }, 10);
                } else {
                    ui.confirmationModal.classList.add('opacity-0');
                    modalContent.classList.add('scale-95');
                    setTimeout(() => ui.confirmationModal.classList.add('hidden'), 250);
                }
            };

            ui.cancelDeleteBtn.addEventListener('click', () => {
                toggleConfirmationModal(false);
                readingToDeleteId = null;
            });

            ui.confirmDeleteBtn.addEventListener('click', async () => {
                if (readingToDeleteId) {
                    const readingDocRef = doc(db, "userData", userId, "readings", readingToDeleteId);
                    await deleteDoc(readingDocRef);
                    toggleConfirmationModal(false);
                    readingToDeleteId = null;
                }
            });

            const renderHeader = () => { ui.patientNameHeader.textContent = patientProfile.name || "Paciente"; };
            const getAge = (dobString) => { if (!dobString) return ''; const birthDate = new Date(dobString); const today = new Date(); let age = today.getFullYear() - birthDate.getFullYear(); const m = today.getMonth() - birthDate.getMonth(); if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) { age--; } return age; };
            const populatePatientForm = () => { ui.patientNameInput.value = patientProfile.name || ''; ui.patientDobInput.value = patientProfile.dob || ''; ui.patientWeightInput.value = patientProfile.weightKg || ''; ui.patientHeightInput.value = patientProfile.heightM || ''; ui.patientConditionsInput.value = patientProfile.conditions || ''; renderMedicationsList(); };
            const renderMedicationsList = () => { ui.modalMedicationsListDiv.innerHTML = ''; if (!patientProfile.medications || patientProfile.medications.length === 0) { ui.modalMedicationsListDiv.innerHTML = '<p class="text-stone-500 text-sm">Nenhuma medicação adicionada.</p>'; } else { patientProfile.medications.forEach(med => { const medEl = document.createElement('div'); medEl.className = 'flex justify-between items-center bg-stone-100 p-2 rounded-lg'; medEl.innerHTML = `<span class="text-sm"><span class="font-semibold">${med.name}</span> - ${med.frequency}</span><button data-id="${med.id}" class="delete-med-btn text-red-500 hover:text-red-700 text-xs font-bold">EXCLUIR</button>`; ui.modalMedicationsListDiv.appendChild(medEl); }); } };
            const setDefaultDateTime = () => { const now = new Date(); const year = now.getFullYear(); const month = String(now.getMonth() + 1).padStart(2, '0'); const day = String(now.getDate()).padStart(2, '0'); ui.dateInput.value = `${year}-${month}-${day}`; const hours = String(now.getHours()).padStart(2, '0'); const minutes = String(now.getMinutes()).padStart(2, '0'); ui.timeInput.value = `${hours}:${minutes}`; };
            const renderChart = () => { const sortedReadings = [...readings].sort((a, b) => a.datetime.seconds - b.datetime.seconds); const labels = sortedReadings.map(r => { const d = new Date(r.datetime.seconds * 1000); return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }) + ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }); }); const sysData = sortedReadings.map(r => r.sys); const diaData = sortedReadings.map(r => r.dia); const data = { labels: labels, datasets: [{ label: 'Sistólica (SYS)', data: sysData, borderColor: '#b91c1c', backgroundColor: 'rgba(185, 28, 28, 0.5)', tension: 0.1, pointRadius: 5, pointHoverRadius: 8 }, { label: 'Diastólica (DIA)', data: diaData, borderColor: '#047857', backgroundColor: 'rgba(4, 120, 87, 0.5)', tension: 0.1, pointRadius: 5, pointHoverRadius: 8 }] }; if (pressureChart) { pressureChart.data = data; pressureChart.update(); } else { const config = { type: 'line', data: data, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, title: { display: true, text: 'mmHg' } } }, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { label += `${context.parsed.y} mmHg`; } return label; } } } } } }; pressureChart = new Chart(ui.chartCanvas, config); } };
            const callGeminiAPI = async (payload, maxRetries = 3) => { let attempt = 0; while (attempt < maxRetries) { try { const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { const errorBody = await response.json(); console.error('Erro na API Gemini:', errorBody); if (errorBody.error && errorBody.error.message.includes("API key not valid")) { return "Erro: A chave de API não é válida. Verifique a chave no código e tente novamente."; } throw new Error(`HTTP error! status: ${response.status}`); } const result = await response.json(); if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) { return result.candidates[0].content.parts[0].text; } else { const finishReason = result.candidates?.[0]?.finishReason; if (finishReason && finishReason !== 'STOP') { return `A análise não pôde ser gerada. Motivo: ${finishReason}. Tente novamente.`; } throw new Error('Resposta da API inválida ou vazia.'); } } catch (error) { attempt++; console.error(`Tentativa ${attempt} de chamar a API Gemini falhou:`, error); if (attempt >= maxRetries) { return "Desculpe, não foi possível obter uma resposta da análise inteligente no momento. Verifique a sua conexão e a chave de API."; } const delay = Math.pow(2, attempt) * 1000; await new Promise(res => setTimeout(res, delay)); } } };
            const handleAnalysis = async () => { if (readings.length === 0) { ui.analysisResult.textContent = "Não há dados suficientes para uma análise."; return; } ui.loadingSpinner.classList.remove('hidden'); ui.analysisResult.textContent = ''; const formattedReadings = readings.map(r => `${new Date(r.datetime.seconds * 1000).toLocaleString('pt-BR')} - ${r.sys}/${r.dia}`).join('\n'); const medicationsText = patientProfile.medications && patientProfile.medications.length > 0 ? patientProfile.medications.map(m => `- ${m.name} (${m.frequency})`).join('\n') : 'Nenhuma medicação informada.'; const patientData = `Dados do paciente:\n- Nome: ${patientProfile.name}\n- Idade: ${getAge(patientProfile.dob)} anos\n- Condições: ${patientProfile.conditions || 'Nenhuma informada'}\n- Medicações:\n${medicationsText}`; const systemPrompt = "Você é um assistente de saúde virtual. Analise os dados de pressão arterial e forneça um resumo geral em português do Brasil. NÃO FORNEÇA ACONSELHAMENTO MÉDICO. Sempre inclua um aviso claro para consultar um médico."; const userQuery = `Analise as seguintes leituras de pressão arterial (Sistólica/Diastólica) para o paciente abaixo.\n\n${patientData}\n\nLeituras:\n${formattedReadings}`; const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } }; const responseText = await callGeminiAPI(payload); ui.analysisResult.textContent = responseText; ui.loadingSpinner.classList.add('hidden'); };
            const handleTipRequest = async () => { ui.loadingSpinner.classList.remove('hidden'); ui.analysisResult.textContent = ''; const systemPrompt = "Você é um assistente de saúde virtual. Forneça uma dica de saúde concisa e prática para o controlo da pressão arterial, em português do Brasil. NÃO FORNEÇA ACONSELHAMENTO MÉDICO."; const userQuery = "Gere uma dica de saúde sobre controlo da pressão arterial."; const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } }; const responseText = await callGeminiAPI(payload); ui.analysisResult.textContent = responseText; ui.loadingSpinner.classList.add('hidden'); };
            const handleDownloadPdf = () => { if (readings.length === 0) { alert("Não há dados para gerar o PDF."); return; } const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.setFontSize(18); doc.text("Relatório de Pressão Arterial", 14, 22); doc.setFontSize(11); let yPos = 32; doc.text(`Paciente: ${patientProfile.name || 'Não informado'}`, 14, yPos); yPos += 7; const age = getAge(patientProfile.dob); doc.text(`Idade: ${age ? age + ' anos' : 'Não informada'}`, 14, yPos); yPos += 9; if (chartCanvas) { const chartImage = chartCanvas.toDataURL('image/png', 1.0); const imgProps = doc.getImageProperties(chartImage); const pdfWidth = doc.internal.pageSize.getWidth(); const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width; doc.addImage(chartImage, 'PNG', 14, yPos, pdfWidth - 28, pdfHeight); yPos += pdfHeight + 10; } doc.autoTable({ head: [["Data", "Hora", "Pressão (SIS/DIA)", "Classificação"]], body: readings.map(r => { const d = new Date(r.datetime.seconds * 1000); return [d.toLocaleDateString('pt-BR'), d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }), `${r.sys} / ${r.dia}`, getClassification(r.sys, r.dia).text] }), startY: yPos, }); const pageCount = doc.internal.getNumberOfPages(); for(let i = 1; i <= pageCount; i++) { doc.setPage(i); doc.setFontSize(8); doc.setTextColor(150); doc.text('Página ' + String(i) + ' de ' + String(pageCount), doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' }); } const fileName = `relatorio_pressao_${(patientProfile.name || 'paciente').replace(/ /g, "_")}.pdf`; doc.save(fileName); };
            function renderAll() { renderHeader(); renderTable(); renderChart(); }
            const toggleModal = (show) => { const modalContent = ui.patientModal.querySelector('div'); if (show) { populatePatientForm(); ui.patientModal.classList.remove('hidden'); setTimeout(() => { ui.patientModal.classList.remove('opacity-0'); modalContent.classList.remove('scale-95'); }, 10); } else { ui.patientModal.classList.add('opacity-0'); modalContent.classList.add('scale-95'); setTimeout(() => { ui.patientModal.classList.add('hidden'); }, 250); } };
            ui.openModalBtn.addEventListener('click', () => toggleModal(true));
            ui.closeModalBtn.addEventListener('click', () => toggleModal(false));
            ui.saveProfileBtn.addEventListener('click', handleSaveProfile);
            ui.patientModal.addEventListener('click', (e) => { if (e.target === ui.patientModal) toggleModal(false); });
            document.addEventListener('keydown', (e) => { if (e.key === "Escape" && !ui.patientModal.classList.contains('hidden')) { toggleModal(false); }});
            ui.medicationForm.addEventListener('submit', (e) => { e.preventDefault(); const name = ui.medicationNameInput.value.trim(); const frequency = ui.medicationFrequencyInput.value.trim(); if (name && frequency) { const newMed = { id: Date.now(), name: name, frequency: frequency }; if (!patientProfile.medications) { patientProfile.medications = []; } patientProfile.medications.push(newMed); renderMedicationsList(); ui.medicationForm.reset(); } });
            ui.modalMedicationsListDiv.addEventListener('click', (e) => { if (e.target.classList.contains('delete-med-btn')) { const idToDelete = parseInt(e.target.getAttribute('data-id')); patientProfile.medications = patientProfile.medications.filter(m => m.id !== idToDelete); renderMedicationsList(); } });
            ui.downloadPdfBtn.addEventListener('click', handleDownloadPdf);
            ui.analyzeBtn.addEventListener('click', handleAnalysis);
            ui.tipBtn.addEventListener('click', handleTipRequest);

            // --- INICIALIZAÇÃO ---
            initializeFirebase();
        });
    </script>
</body>
</html>



