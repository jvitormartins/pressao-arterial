<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Pressão Arterial - Maria José Martins</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 40vh;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #14b8a6;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            transition: opacity 0.25s ease;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-teal-800">Controle de Pressão Arterial</h1>
            <div class="flex justify-center items-center gap-4 mt-2">
                <p class="text-lg text-stone-600" id="patient-name-header"></p>
                <button id="open-modal-btn" class="bg-white border border-teal-600 text-teal-600 font-bold py-1 px-3 rounded-lg hover:bg-teal-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition text-sm">Editar Dados do Paciente</button>
            </div>
        </header>

        <main class="space-y-8">
            <section id="add-reading" class="bg-white p-6 rounded-2xl shadow-lg border border-stone-200">
                <h2 class="text-2xl font-semibold mb-4 text-teal-700">Adicionar Nova Medição</h2>
                <form id="pressure-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                    <div>
                        <label for="date" class="block text-sm font-medium text-stone-600 mb-1">Data</label>
                        <input type="date" id="date" name="date" required class="w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                    <div>
                        <label for="time" class="block text-sm font-medium text-stone-600 mb-1">Hora</label>
                        <input type="time" id="time" name="time" required class="w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                           <label for="systolic" class="block text-sm font-medium text-stone-600 mb-1">Sistólica (SYS)</label>
                           <input type="number" id="systolic" name="systolic" placeholder="ex: 120" required class="w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                        </div>
                        <div>
                           <label for="diastolic" class="block text-sm font-medium text-stone-600 mb-1">Diastólica (DIA)</label>
                           <input type="number" id="diastolic" name="diastolic" placeholder="ex: 80" required class="w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-transform transform hover:scale-105 shadow-md">
                        Salvar Medição
                    </button>
                </form>
                 <p id="form-error" class="text-red-500 text-sm mt-2 hidden"></p>
            </section>
            
            <section id="visualization" class="bg-white p-6 rounded-2xl shadow-lg border border-stone-200">
                <h2 class="text-2xl font-semibold mb-4 text-center text-teal-700">Tendência da Pressão Arterial</h2>
                <div class="chart-container">
                    <canvas id="pressureChart"></canvas>
                </div>
            </section>
            
            <section id="history" class="bg-white p-6 rounded-2xl shadow-lg border border-stone-200">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                    <h2 class="text-2xl font-semibold text-teal-700">Histórico de Medições</h2>
                     <button id="download-pdf-btn" class="mt-4 sm:mt-0 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition shadow-md">
                         Baixar Histórico (PDF)
                     </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="border-b-2 border-stone-200">
                                <th class="p-3 text-sm font-semibold tracking-wider">Data</th>
                                <th class="p-3 text-sm font-semibold tracking-wider">Hora</th>
                                <th class="p-3 text-sm font-semibold tracking-wider">Pressão (SIS/DIA)</th>
                                <th class="p-3 text-sm font-semibold tracking-wider text-center">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body">
                        </tbody>
                    </table>
                     <p id="no-data-message" class="text-center text-stone-500 py-8 hidden">Nenhuma medição registrada ainda.</p>
                </div>
            </section>
            
            <section id="gemini-features" class="bg-white p-6 rounded-2xl shadow-lg border border-stone-200">
                <h2 class="text-2xl font-semibold mb-4 text-teal-700">Análise Inteligente</h2>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                     <button id="analyze-btn" class="flex-1 bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-transform transform hover:scale-105 shadow-md">
                         ✨ Gerar Análise dos Dados
                     </button>
                     <button id="tip-btn" class="flex-1 bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 transition-transform transform hover:scale-105 shadow-md">
                         ✨ Gerar Dica de Saúde
                     </button>
                </div>
                <div id="gemini-output" class="mt-4 p-4 bg-stone-100 rounded-lg min-h-[100px] border border-stone-200 text-stone-700 whitespace-pre-wrap">
                    <div id="loading-spinner" class="hidden mx-auto loader"></div>
                    <p id="analysis-result"></p>
                </div>
            </section>
        </main>
        
        <footer class="text-center mt-8 py-4">
            <p class="text-sm text-stone-500">Atenção: Os dados são salvos apenas no seu navegador. Limpar o cache ou usar outro dispositivo não mostrará o histórico.</p>
            <p class="text-xs text-stone-400 mt-2">Controle de Pressão Arterial desenvolvido por: <i class="font-medium">J. Vitor Martins</i></p>
        </footer>
    </div>
    
    <!-- Patient Data Modal -->
    <div id="patient-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 sm:p-8 transform transition-transform scale-95 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-6 text-teal-800">Dados do Paciente</h2>
            
            <form id="patient-form" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="patient-name" class="block text-sm font-medium text-stone-600">Nome Completo</label>
                        <input type="text" id="patient-name" class="mt-1 w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                     <div>
                        <label for="patient-dob" class="block text-sm font-medium text-stone-600">Data de Nascimento</label>
                        <input type="date" id="patient-dob" class="mt-1 w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label for="patient-weight" class="block text-sm font-medium text-stone-600">Peso (kg)</label>
                        <input type="number" step="0.1" id="patient-weight" class="mt-1 w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label for="patient-height" class="block text-sm font-medium text-stone-600">Altura (m)</label>
                        <input type="number" step="0.01" id="patient-height" class="mt-1 w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-stone-600 mb-2">Outras Condições de Saúde (opcional)</label>
                    <textarea id="patient-conditions" rows="3" placeholder="Ex: Diabetes tipo 2, Colesterol alto" class="w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500"></textarea>
                </div>
            </form>
            
            <hr class="my-6 border-stone-200">
            
            <h3 class="text-xl font-semibold mb-4 text-teal-700">Medicações em Uso</h3>
            <div id="modal-medications-list" class="space-y-2 mb-4 max-h-40 overflow-y-auto"></div>
            <form id="medication-form" class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                <div class="sm:col-span-1">
                    <label for="medication-name" class="block text-sm font-medium text-stone-600 mb-1">Nome da Medicação</label>
                    <input type="text" id="medication-name" placeholder="Ex: Losartana" class="w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
                <div class="sm:col-span-1">
                    <label for="medication-frequency" class="block text-sm font-medium text-stone-600 mb-1">Frequência</label>
                    <input type="text" id="medication-frequency" placeholder="Ex: 1 vez ao dia" class="w-full px-3 py-2 border border-stone-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
                <div class="sm:col-span-1">
                     <button type="submit" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition-transform transform hover:scale-105 shadow-md">Adicionar</button>
                </div>
            </form>

            <div class="flex justify-end gap-4 mt-8">
                <button id="close-modal-btn" class="bg-stone-200 text-stone-800 font-bold py-2 px-6 rounded-lg hover:bg-stone-300 transition">Fechar</button>
                <button id="save-profile-btn" class="bg-teal-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-700 transition shadow-md">Salvar Alterações</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const pressureForm = document.getElementById('pressure-form');
            const dateInput = document.getElementById('date');
            const timeInput = document.getElementById('time');
            const systolicInput = document.getElementById('systolic');
            const diastolicInput = document.getElementById('diastolic');
            const tableBody = document.getElementById('history-table-body');
            const noDataMessage = document.getElementById('no-data-message');
            const formError = document.getElementById('form-error');
            const chartCanvas = document.getElementById('pressureChart');
            
            const analyzeBtn = document.getElementById('analyze-btn');
            const tipBtn = document.getElementById('tip-btn');
            const loadingSpinner = document.getElementById('loading-spinner');
            const analysisResult = document.getElementById('analysis-result');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');

            const patientNameHeader = document.getElementById('patient-name-header');
            
            const patientModal = document.getElementById('patient-modal');
            const openModalBtn = document.getElementById('open-modal-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const saveProfileBtn = document.getElementById('save-profile-btn');
            
            const patientNameInput = document.getElementById('patient-name');
            const patientDobInput = document.getElementById('patient-dob');
            const patientWeightInput = document.getElementById('patient-weight');
            const patientHeightInput = document.getElementById('patient-height');
            const patientConditionsInput = document.getElementById('patient-conditions');

            const modalMedicationsListDiv = document.getElementById('modal-medications-list');
            const medicationForm = document.getElementById('medication-form');
            const medicationNameInput = document.getElementById('medication-name');
            const medicationFrequencyInput = document.getElementById('medication-frequency');

            let pressureChart;

            let patientProfile = JSON.parse(localStorage.getItem('patientProfile_MJM')) || {
                name: "Maria José Martins",
                dob: "1967-01-14",
                weightKg: 68,
                heightM: 1.70,
                conditions: "Hipertensão",
                medications: [
                    { id: 1, name: 'Losartana Potássica', frequency: '1 vez ao dia' }
                ]
            };

            let readings = JSON.parse(localStorage.getItem('pressureReadings_MJM')) || [
                { id: 1, date: '2025-09-21', time: '09:30', sys: 190, dia: 100 }
            ];
            
            const GEMINI_API_KEY = "AIzaSyAv9EmSKxAZmyzsHOwmMXv0F-0SUaFfBUg"; 
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            
            const savePatientProfile = () => {
                localStorage.setItem('patientProfile_MJM', JSON.stringify(patientProfile));
            };

            const getAge = (dobString) => {
                if (!dobString) return '';
                const birthDate = new Date(dobString);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            };

            const renderHeader = () => {
                patientNameHeader.textContent = patientProfile.name || "Paciente";
            };
            
            const populatePatientForm = () => {
                patientNameInput.value = patientProfile.name || '';
                patientDobInput.value = patientProfile.dob || '';
                patientWeightInput.value = patientProfile.weightKg || '';
                patientHeightInput.value = patientProfile.heightM || '';
                patientConditionsInput.value = patientProfile.conditions || '';
                renderMedicationsList();
            };

            const renderMedicationsList = () => {
                modalMedicationsListDiv.innerHTML = '';
                if (!patientProfile.medications || patientProfile.medications.length === 0) {
                    modalMedicationsListDiv.innerHTML = '<p class="text-stone-500 text-sm">Nenhuma medicação adicionada.</p>';
                } else {
                    patientProfile.medications.forEach(med => {
                        const medEl = document.createElement('div');
                        medEl.className = 'flex justify-between items-center bg-stone-100 p-2 rounded-lg';
                        medEl.innerHTML = `
                            <span class="text-sm">
                                <span class="font-semibold">${med.name}</span> - ${med.frequency}
                            </span>
                            <button data-id="${med.id}" class="delete-med-btn text-red-500 hover:text-red-700 text-xs font-bold">EXCLUIR</button>
                        `;
                        modalMedicationsListDiv.appendChild(medEl);
                    });
                }
            };
            
            const handleSaveProfile = () => {
                patientProfile.name = patientNameInput.value.trim();
                patientProfile.dob = patientDobInput.value;
                patientProfile.weightKg = parseFloat(patientWeightInput.value) || 0;
                patientProfile.heightM = parseFloat(patientHeightInput.value) || 0;
                patientProfile.conditions = patientConditionsInput.value.trim();
                savePatientProfile();
                renderAll();
                toggleModal(false);
            };

            const callGeminiAPI = async (payload, maxRetries = 3) => {
                let attempt = 0;
                while (attempt < maxRetries) {
                    try {
                        const response = await fetch(GEMINI_API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                           const errorBody = await response.json();
                           console.error('Erro na API Gemini:', errorBody);
                           if (errorBody.error && errorBody.error.message.includes("API key not valid")) {
                               return "Erro: A chave de API não é válida. Verifique a chave no código e tente novamente.";
                           }
                           throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                            return result.candidates[0].content.parts[0].text;
                        } else {
                            const finishReason = result.candidates?.[0]?.finishReason;
                            if (finishReason && finishReason !== 'STOP') {
                                return `A análise não pôde ser gerada. Motivo: ${finishReason}. Tente novamente.`;
                            }
                            throw new Error('Resposta da API inválida ou vazia.');
                        }
                    } catch (error) {
                        attempt++;
                        console.error(`Tentativa ${attempt} de chamar a API Gemini falhou:`, error);
                        if (attempt >= maxRetries) {
                            return "Desculpe, não foi possível obter uma resposta da análise inteligente no momento. Verifique sua conexão e a chave de API.";
                        }
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(res => setTimeout(res, delay));
                    }
                }
            };
            
            const handleAnalysis = async () => {
                if (readings.length === 0) {
                    analysisResult.textContent = "Não há dados suficientes para uma análise. Por favor, adicione algumas medições primeiro.";
                    return;
                }

                loadingSpinner.classList.remove('hidden');
                analysisResult.textContent = '';
                
                const formattedReadings = readings
                    .map(r => `${new Date(r.date + 'T' + r.time).toLocaleDateString('pt-BR')} ${r.time} - ${r.sys}/${r.dia}`)
                    .join('\n');
                
                const medicationsText = patientProfile.medications && patientProfile.medications.length > 0
                    ? patientProfile.medications.map(m => `- ${m.name} (${m.frequency})`).join('\n')
                    : 'Nenhuma medicação informada.';

                const patientData = `Dados do paciente:
                - Nome: ${patientProfile.name}
                - Idade: ${getAge(patientProfile.dob)} anos
                - Peso: ${patientProfile.weightKg} kg
                - Altura: ${patientProfile.heightM} m
                - Condições de saúde: ${patientProfile.conditions || 'Nenhuma informada'}
                - Medicações em uso:\n${medicationsText}`;

                const systemPrompt = "Você é um assistente de saúde virtual. Sua função é analisar dados de pressão arterial e fornecer um resumo geral e dicas de estilo de vida em português do Brasil, considerando os dados do paciente, incluindo suas medicações. NÃO FORNEÇA ACONSELHAMENTO MÉDICO. Sempre inclua um aviso claro para consultar um médico para obter orientação profissional. Formate a resposta de forma clara e amigável.";
                const userQuery = `Analise as seguintes leituras de pressão arterial (Sistólica/Diastólica) para a paciente abaixo e forneça um resumo das tendências.\n\n${patientData}\n\nLeituras:\n${formattedReadings}\n\nDestaque quaisquer padrões e ofereça dicas gerais de estilo de vida para controle da pressão arterial.`;
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };

                const responseText = await callGeminiAPI(payload);
                analysisResult.textContent = responseText;
                loadingSpinner.classList.add('hidden');
            };
            
            const handleTipRequest = async () => {
                loadingSpinner.classList.remove('hidden');
                analysisResult.textContent = '';

                const systemPrompt = "Você é um assistente de saúde virtual. Forneça uma dica de saúde concisa e prática para o controle da pressão arterial, em português do Brasil. A dica deve ser fácil de entender e aplicar no dia a dia. NÃO FORNEÇA ACONSELHAMENTO MÉDICO.";
                const userQuery = "Gere uma dica de saúde sobre controle da pressão arterial.";
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };
                
                const responseText = await callGeminiAPI(payload);
                analysisResult.textContent = responseText;
                loadingSpinner.classList.add('hidden');
            };

            analyzeBtn.addEventListener('click', handleAnalysis);
            tipBtn.addEventListener('click', handleTipRequest);

            const saveReadings = () => {
                localStorage.setItem('pressureReadings_MJM', JSON.stringify(readings));
            };
            
            const formatPressureValue = (value) => {
                const num = parseInt(value, 10);
                if (isNaN(num)) return '000';
                return String(num); // PDF doesn't need padding
            };

            const renderTable = () => {
                tableBody.innerHTML = '';
                if (readings.length === 0) {
                    noDataMessage.classList.remove('hidden');
                    return;
                }
                noDataMessage.classList.add('hidden');
                
                const sortedReadings = [...readings].sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));

                sortedReadings.forEach(reading => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-stone-200 hover:bg-stone-50';
                    
                    const formattedDate = new Date(reading.date + 'T00:00:00').toLocaleDateString('pt-BR');

                    row.innerHTML = `
                        <td class="p-3">${formattedDate}</td>
                        <td class="p-3">${reading.time}</td>
                        <td class="p-3 font-medium">${reading.sys} / ${reading.dia}</td>
                        <td class="p-3 text-center">
                            <button data-id="${reading.id}" class="delete-btn text-red-500 hover:text-red-700 font-semibold text-sm">Excluir</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            };

            const renderChart = () => {
                const sortedReadings = [...readings].sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));

                const labels = sortedReadings.map(r => {
                     const d = new Date(r.date + 'T' + r.time);
                     return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }) + ' ' + r.time;
                });
                const sysData = sortedReadings.map(r => r.sys);
                const diaData = sortedReadings.map(r => r.dia);

                const data = {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Sistólica (SYS)',
                            data: sysData,
                            borderColor: '#b91c1c', // red-700
                            backgroundColor: 'rgba(185, 28, 28, 0.5)',
                            tension: 0.1,
                            pointRadius: 5,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Diastólica (DIA)',
                            data: diaData,
                            borderColor: '#047857', // emerald-700
                            backgroundColor: 'rgba(4, 120, 87, 0.5)',
                            tension: 0.1,
                            pointRadius: 5,
                            pointHoverRadius: 8
                        }
                    ]
                };

                if (pressureChart) {
                    pressureChart.data = data;
                    pressureChart.update();
                } else {
                    const config = {
                        type: 'line',
                        data: data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: false, title: { display: true, text: 'mmHg' } }
                            },
                            plugins: {
                                legend: { position: 'top' },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) { label += ': '; }
                                            if (context.parsed.y !== null) { label += `${context.parsed.y} mmHg`; }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    };
                    pressureChart = new Chart(chartCanvas, config);
                }
            };
            
            const setDefaultDateTime = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                dateInput.value = `${year}-${month}-${day}`;
                
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                timeInput.value = `${hours}:${minutes}`;
            };

            pressureForm.addEventListener('submit', (e) => {
                e.preventDefault();
                formError.classList.add('hidden');

                const sys = parseInt(systolicInput.value);
                const dia = parseInt(diastolicInput.value);

                if (isNaN(sys) || isNaN(dia) || sys <= 0 || dia <= 0) {
                    formError.textContent = 'Por favor, insira valores numéricos válidos para a pressão.';
                    formError.classList.remove('hidden');
                    return;
                }
                 if (sys < dia) {
                    formError.textContent = 'A pressão sistólica deve ser maior que a diastólica.';
                    formError.classList.remove('hidden');
                    return;
                }

                const newReading = {
                    id: Date.now(),
                    date: dateInput.value,
                    time: timeInput.value,
                    sys: sys,
                    dia: dia
                };

                readings.push(newReading);
                saveReadings();
                renderAll();
                pressureForm.reset();
                setDefaultDateTime();
            });
            
            tableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const idToDelete = parseInt(e.target.getAttribute('data-id'));
                    readings = readings.filter(r => r.id !== idToDelete);
                    saveReadings();
                    renderAll();
                }
            });
            
            medicationForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = medicationNameInput.value.trim();
                const frequency = medicationFrequencyInput.value.trim();

                if (name && frequency) {
                    const newMed = {
                        id: Date.now(),
                        name: name,
                        frequency: frequency
                    };
                    if (!patientProfile.medications) {
                        patientProfile.medications = [];
                    }
                    patientProfile.medications.push(newMed);
                    renderMedicationsList();
                    medicationForm.reset();
                }
            });

            modalMedicationsListDiv.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-med-btn')) {
                    const idToDelete = parseInt(e.target.getAttribute('data-id'));
                    patientProfile.medications = patientProfile.medications.filter(m => m.id !== idToDelete);
                    renderMedicationsList();
                }
            });

            const handleDownloadPdf = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.text("Relatório de Pressão Arterial", 14, 22);
                
                doc.setFontSize(11);
                let yPos = 32;
                doc.text(`Paciente: ${patientProfile.name || 'Não informado'}`, 14, yPos); 
                yPos += 7;
                const age = getAge(patientProfile.dob);
                doc.text(`Idade: ${age ? age + ' anos' : 'Não informada'}`, 14, yPos); 
                yPos += 9;

                doc.setFontSize(12);
                doc.text("Medicações em Uso:", 14, yPos); 
                yPos += 7;
                doc.setFontSize(10);
                if (patientProfile.medications && patientProfile.medications.length > 0) {
                    patientProfile.medications.forEach(med => {
                        doc.text(`- ${med.name} (${med.frequency})`, 14, yPos);
                        yPos += 5;
                    });
                } else {
                    doc.text("- Nenhuma medicação informada.", 14, yPos);
                    yPos += 5;
                }

                const tableColumn = ["Data", "Hora", "Pressão (SIS/DIA)"];
                const tableRows = [];

                const sortedReadings = [...readings].sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));

                sortedReadings.forEach(reading => {
                    const readingData = [
                        new Date(reading.date + 'T00:00:00').toLocaleDateString('pt-BR'),
                        reading.time,
                        `${formatPressureValue(reading.sys)} / ${formatPressureValue(reading.dia)}`
                    ];
                    tableRows.push(readingData);
                });
                
                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: yPos + 2,
                });
                
                // --- ASSINATURA NO PDF ---
                const pageHeight = doc.internal.pageSize.getHeight();
                doc.setFontSize(8);
                doc.setTextColor(150); // Cor cinza discreta
                const signatureText = "Controle de Pressão Arterial desenvolvido por: ";
                const signatureName = "J. Vitor Martins";
                const textWidth = doc.getStringUnitWidth(signatureText + signatureName) * doc.internal.getFontSize() / doc.internal.scaleFactor;
                const textX = (doc.internal.pageSize.getWidth() - textWidth) / 2; // Centralizado

                doc.setFont('helvetica', 'normal');
                doc.text(signatureText, textX, pageHeight - 10);
                
                const nameX = textX + doc.getStringUnitWidth(signatureText) * doc.internal.getFontSize() / doc.internal.scaleFactor;
                doc.setFont('helvetica', 'italic');
                doc.text(signatureName, nameX, pageHeight - 10);
                // --- FIM DA ASSINATURA ---

                const fileName = `relatorio_pressao_${(patientProfile.name || 'paciente').replace(/ /g, "_")}.pdf`;
                doc.save(fileName);
            };

            downloadPdfBtn.addEventListener('click', handleDownloadPdf);

            const toggleModal = (show) => {
                const modalContent = patientModal.querySelector('div');
                if (show) {
                    populatePatientForm();
                    patientModal.classList.remove('hidden');
                    setTimeout(() => {
                        patientModal.classList.remove('opacity-0');
                        modalContent.classList.remove('scale-95');
                    }, 10);
                } else {
                    patientModal.classList.add('opacity-0');
                    modalContent.classList.add('scale-95');
                    setTimeout(() => {
                        patientModal.classList.add('hidden');
                    }, 250);
                }
            };
            
            openModalBtn.addEventListener('click', () => toggleModal(true));
            closeModalBtn.addEventListener('click', () => toggleModal(false));
            saveProfileBtn.addEventListener('click', handleSaveProfile);

            function renderAll() {
                renderHeader();
                renderTable();
                renderChart();
            }
            
            setDefaultDateTime();
            renderAll();
        });
    </script>
</body>
</html>

